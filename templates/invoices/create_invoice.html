{% extends 'dashboard/base.html' %}

{% block content %}

<h4 class="mb-4">ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</h4>

<form method="post">
    {% csrf_token %}

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        </div>
  <div class="card-body row">
         <div class="col-md-3 mb-3">
        {{ invoice_form.invoice_number.label_tag }}
        {{ invoice_form.invoice_number }}

        {% if invoice_form.invoice_number.errors %}
            <div class="text-danger mt-1">
                {{ invoice_form.invoice_number.errors }}
            </div>
        {% endif %}
    </div>

        <div class="col-md-3 mb-3">
        {{ invoice_form.invoice_type.label_tag }}
        {{ invoice_form.invoice_type }}
    </div>

    <!-- Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
    <div class="col-md-3 mb-3">
        {{ invoice_form.customer_name.label_tag }}
        {{ invoice_form.customer_name }}
    </div>

    <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <div class="col-md-3 mb-3">
        {{ invoice_form.invoice_date.label_tag }}
        {{ invoice_form.invoice_date }}

        {% if invoice_form.invoice_date.errors %}
            <div class="text-danger mt-1">
                {{ invoice_form.invoice_date.errors }}
            </div>
        {% endif %}
    </div>

</div>

    <div class="card">
        <div class="card-header bg-dark text-white">
            Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        </div>
        <div class="card-body">

            {{ formset.management_form }}

            <table class="table table-bordered text-center">
                <thead>
                    <tr>
                        <th>Ø§Ù„ÙˆØµÙ</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    {% for form in formset %}
                    <tr class="item-row">
                        <td>{{ form.description }}</td>
                        <td>{{ form.quantity }}</td>
                        <td>{{ form.unit_price }}</td>
                        <td>
                            <input type="text" class="form-control total-field" readonly>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm remove-row">
                                ğŸ—‘
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="mt-3">
                <button type="button" id="add-item" class="btn btn-outline-primary mt-2" >
                     â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯
                </button>

        </div>
        <div class="mt-3 text-end">
            <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</strong>
            <span id="grand-total">0</span>
        </div>

    </div>
</div>

    <div class="mt-3 text-end">
        <button type="submit" class="btn btn-success">
            ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        </button>
    </div>
    
 <div id="empty-form" style="display:none;">
    {{ formset.empty_form }}
 </div>

</form>
<script>
const itemsContainer = document.getElementById('invoice-items');
const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
const emptyFormTemplate = document.getElementById('empty-form').innerHTML;

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
function updateTotals() {
    let grandTotal = 0;

    document.querySelectorAll('.item-row').forEach(row => {
        if (row.style.display === 'none') return;

        const qty = row.querySelector('input[name$="quantity"]');
        const price = row.querySelector('input[name$="unit_price"]');
        const totalField = row.querySelector('.total-field');

        if (!qty || !price) return;

        const q = parseFloat(qty.value) || 0;
        const p = parseFloat(price.value) || 0;

        if (q === 0 || p === 0) {
            totalField.value = 'âš ';
            return;
        }

        const total = q * p;
        totalField.value = total.toFixed(2);
        grandTotal += total;
    });

    document.getElementById('grand-total').innerText = grandTotal.toFixed(2);
}

// Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯
document.getElementById('add-item').addEventListener('click', function () {
    let formIndex = parseInt(totalFormsInput.value);

    let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formIndex);

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = newFormHtml;

    const row = document.createElement('tr');
    row.classList.add('item-row');

    tempDiv.querySelectorAll('input, select, textarea').forEach(input => {
        const td = document.createElement('td');
        td.appendChild(input);
        row.appendChild(td);
    });

    const totalTd = document.createElement('td');
    totalTd.innerHTML = `<input type="text" class="form-control total-field" readonly>`;
    row.appendChild(totalTd);

    const deleteTd = document.createElement('td');
    deleteTd.innerHTML = `<button type="button" class="btn btn-danger btn-sm remove-row">ğŸ—‘</button>`;
    row.appendChild(deleteTd);

    itemsContainer.appendChild(row);
    totalFormsInput.value = formIndex + 1;
});

// Ø­Ø°Ù Ø¨Ù†Ø¯
document.addEventListener('click', function (e) {
    const btn = e.target.closest('.remove-row');
    if (!btn) return;

    const row = btn.closest('.item-row');
    row.style.display = 'none';

    const inputs = row.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.name.includes('DELETE')) {
            input.checked = true;
        }
    });

    updateTotals();
});

// ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ
document.addEventListener('input', function (e) {
    if (e.target.name?.includes('quantity') || e.target.name?.includes('unit_price')) {
        updateTotals();
    }
});
</script>

{% endblock %}
